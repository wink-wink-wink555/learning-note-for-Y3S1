# ğŸ”§ 500é”™è¯¯è°ƒè¯•æŒ‡å—

## å½“å‰é—®é¢˜

æµè§ˆå™¨æ˜¾ç¤ºï¼š`Failed to load resource: the server responded with a status of 500 (INTERNAL SERVER ERROR)`

è¿™è¡¨ç¤ºåç«¯ä»£ç æ‰§è¡Œæ—¶å‡ºé”™äº†ã€‚

## ğŸ” å¿«é€Ÿè¯Šæ–­æ­¥éª¤

### æ­¥éª¤1ï¼šæŸ¥çœ‹æœåŠ¡å™¨æ§åˆ¶å°

åœ¨è¿è¡Œ `python run.py` çš„ç»ˆç«¯çª—å£ä¸­ï¼Œåº”è¯¥ä¼šçœ‹åˆ°è¯¦ç»†çš„é”™è¯¯å †æ ˆä¿¡æ¯ã€‚

**è¯·å¤åˆ¶å®Œæ•´çš„é”™è¯¯ä¿¡æ¯**ï¼ŒåŒ…æ‹¬ï¼š
- `Traceback (most recent call last):`
- æ‰€æœ‰çš„æ–‡ä»¶è·¯å¾„å’Œè¡Œå·
- æœ€åçš„é”™è¯¯ç±»å‹å’Œæ¶ˆæ¯

### æ­¥éª¤2ï¼šå¸¸è§çš„500é”™è¯¯åŸå› 

#### åŸå› 1ï¼šæ•°æ®åº“è¿æ¥é—®é¢˜

**ç—‡çŠ¶ï¼š** `sqlalchemy.exc.OperationalError`

**æ£€æŸ¥ï¼š**
```bash
# åœ¨MySQL Workbenchä¸­æµ‹è¯•è¿æ¥
USE textbook_management;
SELECT COUNT(*) FROM user;
```

**è§£å†³ï¼š**
- ç¡®ä¿MySQLæœåŠ¡æ­£åœ¨è¿è¡Œ
- æ£€æŸ¥ `config.py` ä¸­çš„æ•°æ®åº“é…ç½®

#### åŸå› 2ï¼šJWT Tokené—®é¢˜

**ç—‡çŠ¶ï¼š** `AttributeError: 'NoneType' object has no attribute 'get'`

**åŸå› ï¼š** å¯èƒ½æ˜¯åœ¨ä½¿ç”¨ `get_jwt_identity()` æ—¶Tokenå·²è¿‡æœŸæˆ–æ— æ•ˆ

**è§£å†³ï¼š** é‡æ–°ç™»å½•è·å–æ–°Token

#### åŸå› 3ï¼šå…³ç³»æŸ¥è¯¢å¤±è´¥

**ç—‡çŠ¶ï¼š** åœ¨è°ƒç”¨ `to_dict(include_relations=True)` æ—¶å‡ºé”™

**å¯èƒ½åŸå› ï¼š**
- å…³è”çš„æ•°æ®ä¸å­˜åœ¨
- å¤–é”®çº¦æŸé—®é¢˜

#### åŸå› 4ï¼šæ—¥æœŸåºåˆ—åŒ–é—®é¢˜

**ç—‡çŠ¶ï¼š** `TypeError: Object of type datetime is not JSON serializable`

**å·²ä¿®å¤ï¼š** Modelçš„ `to_dict()` æ–¹æ³•å·²æ­£ç¡®å¤„ç†æ—¥æœŸè½¬æ¢

## ğŸ› ï¸ ä¸´æ—¶ä¿®å¤æ–¹æ¡ˆ

å¦‚æœæ— æ³•ç«‹å³è§£å†³ï¼Œå¯ä»¥å…ˆç¦ç”¨æƒé™æ§åˆ¶æµ‹è¯•åŸºæœ¬åŠŸèƒ½ï¼š

### æ–¹æ¡ˆ1ï¼šä¸´æ—¶ç§»é™¤è£…é¥°å™¨

ç¼–è¾‘å‡ºé”™çš„APIæ–‡ä»¶ï¼Œä¸´æ—¶æ³¨é‡Šæ‰è£…é¥°å™¨ï¼š

```python
@api_v1.route('/purchase-orders', methods=['GET'])
@jwt_required()
# @teacher_required  # ä¸´æ—¶æ³¨é‡Š
def get_purchase_orders():
    # ...
```

### æ–¹æ¡ˆ2ï¼šæ·»åŠ è¯¦ç»†æ—¥å¿—

åœ¨å‡ºé”™çš„APIä¸­æ·»åŠ æ‰“å°è¯­å¥ï¼š

```python
@api_v1.route('/purchase-orders', methods=['GET'])
@jwt_required()
@teacher_required
def get_purchase_orders():
    try:
        print("=== DEBUG: å¼€å§‹è·å–è®¢å•åˆ—è¡¨ ===")
        current_user = get_jwt_identity()
        print(f"å½“å‰ç”¨æˆ·: {current_user}")
        role = current_user.get('role')
        print(f"ç”¨æˆ·è§’è‰²: {role}")
        
        page, per_page = get_pagination_params()
        print(f"åˆ†é¡µå‚æ•°: page={page}, per_page={per_page}")
        
        # ... å…¶ä½™ä»£ç 
        
    except Exception as e:
        print(f"!!! é”™è¯¯: {type(e).__name__}: {str(e)}")
        import traceback
        traceback.print_exc()
        return error_response(message=str(e))
```

## ğŸ“‹ è¯¦ç»†æ’æŸ¥æ¸…å•

### 1. æ£€æŸ¥æ˜¯å¦å·²å®‰è£…æ‰€æœ‰ä¾èµ–

```bash
pip list | findstr Flask
# åº”è¯¥çœ‹åˆ°ï¼š
# Flask          3.0.0
# Flask-CORS     4.0.0
# Flask-JWT-Extended  4.6.0
# Flask-Migrate  4.0.5
# Flask-SQLAlchemy  3.1.1
```

### 2. æ£€æŸ¥æ•°æ®åº“è¿æ¥é…ç½®

æŸ¥çœ‹ `config.py`ï¼š

```python
SQLALCHEMY_DATABASE_URI = 'mysql+pymysql://ç”¨æˆ·å:å¯†ç @localhost:3306/textbook_management?charset=utf8mb4'
```

ç¡®ä¿ï¼š
- ç”¨æˆ·åå¯†ç æ­£ç¡®
- MySQLåœ¨localhost:3306è¿è¡Œ
- æ•°æ®åº“åæ˜¯ `textbook_management`

### 3. æµ‹è¯•æ•°æ®åº“è¿æ¥

åˆ›å»ºæµ‹è¯•è„šæœ¬ `test_db.py`ï¼š

```python
from app import create_app
from app.extensions import db

app = create_app()

with app.app_context():
    try:
        # æµ‹è¯•æ•°æ®åº“è¿æ¥
        result = db.session.execute(db.text("SELECT 1")).scalar()
        print(f"âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ: {result}")
        
        # æµ‹è¯•ç”¨æˆ·è¡¨
        from app.models.user import User
        user_count = User.query.count()
        print(f"âœ… ç”¨æˆ·è¡¨è®°å½•æ•°: {user_count}")
        
        # æµ‹è¯•æ•™æè¡¨
        from app.models.textbook import Textbook
        textbook_count = Textbook.query.count()
        print(f"âœ… æ•™æè¡¨è®°å½•æ•°: {textbook_count}")
        
    except Exception as e:
        print(f"âŒ é”™è¯¯: {e}")
        import traceback
        traceback.print_exc()
```

è¿è¡Œï¼š
```bash
python test_db.py
```

### 4. æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·æ•°æ®

```sql
USE textbook_management;
SELECT user_id, username, real_name, role FROM user;
```

å¦‚æœæ²¡æœ‰ç”¨æˆ·ï¼Œåˆ›å»ºæµ‹è¯•ç”¨æˆ·ï¼š

```sql
INSERT INTO user (username, password, real_name, role, department, email, status)
VALUES 
('admin', 'admin123', 'ç®¡ç†å‘˜', 'ç®¡ç†å‘˜', 'ç®¡ç†éƒ¨', 'admin@example.com', 1),
('teacher', 'teacher123', 'ç‹è€å¸ˆ', 'æ•™å¸ˆ', 'è®¡ç®—æœºç³»', 'teacher@example.com', 1);
```

### 5. æµ‹è¯•APIï¼ˆä¸ä½¿ç”¨å‰ç«¯ï¼‰

ä½¿ç”¨curlæˆ–Postmanæµ‹è¯•ï¼š

```bash
# 1. æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost:5000/api/health

# 2. æµ‹è¯•ç™»å½•
curl -X POST http://localhost:5000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d "{\"username\":\"admin\",\"password\":\"admin123\"}"

# 3. æµ‹è¯•è·å–æ•™æåˆ—è¡¨ï¼ˆéœ€è¦Tokenï¼‰
curl http://localhost:5000/api/v1/textbooks \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

## ğŸ› å¯èƒ½çš„å…·ä½“é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

### é”™è¯¯Aï¼šAttributeError: 'dict' object has no attribute 'get'

```python
# é”™è¯¯ä»£ç 
current_user = get_jwt_identity()  # è¿”å›çš„æ˜¯å­—ç¬¦ä¸²user_idï¼Œä¸æ˜¯å­—å…¸
role = current_user.get('role')  # âŒ å­—ç¬¦ä¸²æ²¡æœ‰getæ–¹æ³•
```

**è§£å†³æ–¹æ¡ˆï¼š** æ£€æŸ¥JWTé…ç½®ï¼Œç¡®ä¿ä½¿ç”¨äº† `additional_claims`

æŸ¥çœ‹ `app/services/auth_service.py` ç¬¬40-48è¡Œï¼š
```python
identity = str(user.user_id)
additional_claims = {
    'username': user.username,
    'role': user.role,
    'real_name': user.real_name
}
access_token = create_access_token(identity=identity, additional_claims=additional_claims)
```

å¦‚æœé—®é¢˜ä¾ç„¶å­˜åœ¨ï¼Œä¿®æ”¹APIè·å–ç”¨æˆ·ä¿¡æ¯çš„æ–¹å¼ï¼š

```python
from flask_jwt_extended import get_jwt

current_user = get_jwt()  # è·å–å®Œæ•´çš„JWTè½½è·ï¼ŒåŒ…æ‹¬additional_claims
role = current_user.get('role')
```

### é”™è¯¯Bï¼šIntegrityError æˆ– ForeignKeyé”™è¯¯

```
sqlalchemy.exc.IntegrityError: (pymysql.err.IntegrityError) (1452, 'Cannot add or update a child row: a foreign key constraint fails')
```

**åŸå› ï¼š** å¼•ç”¨çš„å¤–é”®è®°å½•ä¸å­˜åœ¨

**è§£å†³ï¼š** ç¡®ä¿æ ·æœ¬æ•°æ®å·²æ’å…¥ï¼š
```bash
# åœ¨MySQLä¸­è¿è¡Œ
source D:/Pycharm/DatabaseProj/sql/05_insert_sample_data.sql
```

### é”™è¯¯Cï¼šUnicodeDecodeError

```
UnicodeDecodeError: 'utf-8' codec can't decode byte
```

**è§£å†³ï¼š** ç¡®ä¿MySQLè¿æ¥ä½¿ç”¨UTF-8ï¼š
```python
SQLALCHEMY_DATABASE_URI = 'mysql+pymysql://root:password@localhost:3306/textbook_management?charset=utf8mb4'
```

## âœ… æˆåŠŸæ ‡å¿—

ä¿®å¤åï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ï¼š

1. **æœåŠ¡å™¨å¯åŠ¨æ­£å¸¸ï¼š**
```
 * Running on http://127.0.0.1:5000
 * Debug mode: on
```

2. **APIå“åº”æ­£å¸¸ï¼š**
```json
{
  "code": 200,
  "message": "success",
  "data": [...]
}
```

3. **å‰ç«¯é¡µé¢åŠ è½½æˆåŠŸï¼š**
- ä»ªè¡¨ç›˜æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
- è®¢å•ç®¡ç†æ˜¾ç¤ºè®¢å•åˆ—è¡¨
- ç»Ÿè®¡æŠ¥è¡¨æ˜¾ç¤ºå›¾è¡¨

## ğŸ“ éœ€è¦å¸®åŠ©

å¦‚æœä»¥ä¸Šæ–¹æ³•éƒ½æ— æ³•è§£å†³ï¼Œè¯·æä¾›ï¼š

1. **æœåŠ¡å™¨æ§åˆ¶å°çš„å®Œæ•´é”™è¯¯ä¿¡æ¯**ï¼ˆåŒ…æ‹¬Tracebackï¼‰
2. **è®¿é—®çš„å…·ä½“URL**ï¼ˆä¾‹å¦‚ï¼š`/api/v1/purchase-orders?page=1&per_page=10`ï¼‰
3. **ä½¿ç”¨çš„ç”¨æˆ·è§’è‰²**ï¼ˆç®¡ç†å‘˜/æ•™å¸ˆ/æ™®é€šç”¨æˆ·ï¼‰
4. **æ•°æ®åº“ä¸­æ˜¯å¦æœ‰æ•°æ®**ï¼ˆè¿è¡Œä¸Šé¢çš„SQLæ£€æŸ¥ï¼‰

---

**æœ€åæ›´æ–°ï¼š** 2026-01-10  
**ç›¸å…³æ–‡æ¡£ï¼š** `docs/é—®é¢˜ä¿®å¤æŒ‡å—.md`
