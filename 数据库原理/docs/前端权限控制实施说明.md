# 前端权限控制实施说明

## 📋 实施概述

**实施日期**: 2026-01-10  
**目标**: 在前端实现权限感知的用户界面，避免用户点击后才看到403错误，提升用户体验

---

## ✅ 已实现的功能

### 1. 权限检查工具函数（utils.js）

在 `app/static/js/utils.js` 中新增了以下权限检查函数：

#### 基础权限检查
- **`hasRole(roles)`** - 检查用户是否具有指定角色
- **`isAdmin()`** - 检查是否为管理员
- **`isAdminOrWarehouse()`** - 检查是否为管理员或仓库管理员
- **`isTeacherOrAbove()`** - 检查是否为教师及以上角色
- **`canManageBasicData()`** - 检查是否可以管理基础数据（仅管理员）

#### UI控制函数
- **`hideIfNoPermission(selector, checkFunc)`** - 隐藏无权限元素
- **`disableIfNoPermission(selector, checkFunc, tooltipText)`** - 禁用无权限元素
- **`applyPermissions(config)`** - 批量应用权限控制
- **`checkPermissionBeforeAction(checkFunc, callback, message)`** - 在操作前检查权限

---

## 📄 页面改造详情

### 2. 教材管理（textbooks.html）

#### 权限规则
- **只有管理员** 可以添加、编辑、删除教材
- 其他用户只能查看

#### 实施措施
✅ "添加教材"按钮：非管理员显示为半透明，点击提示权限不足  
✅ 编辑/删除按钮：非管理员用户只显示"查看"文字  
✅ 操作前权限检查：点击操作时会先检查权限，无权限时弹出友好提示

```javascript
// 示例代码
function showAddModal() {
    checkPermissionBeforeAction(
        canManageBasicData,
        () => { /* 显示模态框 */ },
        '只有管理员可以添加教材'
    );
}
```

---

### 3. 出版社管理（publishers.html）

#### 权限规则
- **只有管理员** 可以添加、编辑、删除出版社
- 其他用户只能查看

#### 实施措施
✅ "添加出版社"按钮：非管理员显示为半透明，点击提示权限不足  
✅ 编辑/删除按钮：非管理员用户只显示"查看"文字  
✅ 操作前权限检查：与教材管理相同

---

### 4. 订单管理（orders.html）

#### 权限规则
- **教师及以上** 可以创建订单
- **管理员和仓库管理员** 可以审核订单
- **管理员和仓库管理员** 可以取消任何订单
- **教师** 只能取消自己的待审核订单

#### 实施措施
✅ "创建订单"按钮：非教师及以上角色显示为半透明  
✅ 审核按钮：只对管理员和仓库管理员显示  
✅ 取消按钮：根据角色和订单状态动态显示  
✅ 智能按钮生成：`getActionButtons(item)` 根据用户角色和订单状态生成操作按钮

```javascript
// 示例：动态生成操作按钮
function getActionButtons(item) {
    let buttons = [];
    
    // 审核按钮：只有管理员和仓库管理员可以审核
    if (item.order_status === '待审核' && isAdminOrWarehouse()) {
        buttons.push(`<button onclick="approveOrder(${item.order_id})">审核</button>`);
    }
    
    // 取消按钮：根据角色和状态判断
    if (item.order_status !== '已到货' && item.order_status !== '已取消') {
        if (isAdminOrWarehouse() || 
            (isTeacherOrAbove() && item.order_status === '待审核')) {
            buttons.push(`<button onclick="cancelOrder(${item.order_id})">取消</button>`);
        }
    }
    
    return buttons.length > 0 ? buttons.join(' ') : '-';
}
```

---

### 5. 仪表盘（dashboard.html）

#### 权限规则
- **所有登录用户** 可以查看基础统计卡片
- **管理员和仓库管理员** 可以查看库存预警
- **教师及以上** 可以查看类型统计

#### 实施措施
✅ 库存预警卡片：非管理员/仓库管理员显示为半透明，数值显示"-"  
✅ 库存预警表格：无权限时显示友好提示文字  
✅ 403错误捕获：API返回403时不报错，而是显示权限提示

```javascript
// 示例：库存预警权限检查
async function loadWarnings() {
    if (!isAdminOrWarehouse()) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center" style="color: #999;">' +
                         '您没有权限查看库存预警数据</td></tr>';
        return;
    }
    // ... 加载数据
}
```

---

### 6. 统计报表（statistics.html）

#### 权限规则
- **教师及以上** 可以查看按类型/出版社统计
- **管理员和仓库管理员** 可以查看库存预警
- **普通用户** 无法访问任何报表

#### 实施措施
✅ 普通用户访问时显示醒目的权限提示横幅  
✅ 每个报表表格：无权限时显示友好提示文字  
✅ 导出按钮：无权限时点击弹出提示，不执行导出  
✅ 403错误捕获：API返回403时显示权限提示

```javascript
// 示例：导出数据权限检查
function exportData(type) {
    if (type === 'warnings' && !isAdminOrWarehouse()) {
        showMessage('您没有权限导出库存预警数据', 'warning');
        return;
    }
    // ... 执行导出
}
```

---

## 🎨 用户体验改进

### 改进前 ❌
1. 普通用户看到"添加教材"按钮
2. 点击按钮，填写表单
3. 提交后看到 **403 Forbidden** 错误
4. 用户困惑："为什么让我点，又不让我操作？"

### 改进后 ✅
1. 普通用户看到半透明的"添加教材"按钮，鼠标悬停提示："只有管理员可以添加教材"
2. 点击按钮，弹出提示：**"只有管理员可以添加教材"**
3. 用户清楚："原来我没权限，那我就不操作了"

---

## 📊 权限矩阵对照表

| 功能模块 | 管理员 | 仓库管理员 | 教师 | 普通用户 | 前端控制 |
|---------|--------|-----------|------|----------|---------|
| **教材管理** |
| 查看教材列表 | ✅ | ✅ | ✅ | ✅ | 无限制 |
| 添加/编辑/删除教材 | ✅ | ❌ | ❌ | ❌ | 按钮半透明+提示 |
| **出版社管理** |
| 查看出版社列表 | ✅ | ✅ | ✅ | ✅ | 无限制 |
| 添加/编辑/删除出版社 | ✅ | ❌ | ❌ | ❌ | 按钮半透明+提示 |
| **订单管理** |
| 查看所有订单 | ✅ | ✅ | ❌ | ❌ | 数据过滤 |
| 查看自己的订单 | ✅ | ✅ | ✅ | ❌ | 数据过滤 |
| 创建订单 | ✅ | ✅ | ✅ | ❌ | 按钮半透明+提示 |
| 审核订单 | ✅ | ✅ | ❌ | ❌ | 按钮不显示 |
| 取消任何订单 | ✅ | ✅ | ❌ | ❌ | 按钮不显示 |
| 取消自己的待审核订单 | ✅ | ✅ | ✅ | ❌ | 动态显示 |
| **统计报表** |
| 按类型/出版社统计 | ✅ | ✅ | ✅ | ❌ | 表格显示权限提示 |
| 库存预警 | ✅ | ✅ | ❌ | ❌ | 表格显示权限提示 |
| 导出报表 | ✅ | ✅ | ✅ | ❌ | 点击提示 |
| **仪表盘** |
| 基础统计卡片 | ✅ | ✅ | ✅ | ✅ | 无限制 |
| 库存预警数据 | ✅ | ✅ | ❌ | ❌ | 半透明+权限提示 |

---

## 🚀 使用方式

### 在新页面中应用权限控制

如果需要在新页面添加权限控制，只需：

1. **引入utils.js**
```html
<script src="/static/js/utils.js"></script>
```

2. **检查权限并控制UI**
```javascript
// 方式1: 隐藏按钮
if (!canManageBasicData()) {
    document.querySelector('#addButton').style.display = 'none';
}

// 方式2: 禁用按钮
window.addEventListener('load', function() {
    if (!isAdmin()) {
        const btn = document.querySelector('#dangerButton');
        btn.style.opacity = '0.5';
        btn.style.cursor = 'not-allowed';
        btn.title = '只有管理员可以操作';
    }
});

// 方式3: 操作前检查
function dangerousAction() {
    checkPermissionBeforeAction(
        isAdmin,
        () => { /* 执行操作 */ },
        '只有管理员可以执行此操作'
    );
}

// 方式4: 动态生成按钮
function getActionButtons(item) {
    if (!isAdmin()) {
        return '<span style="color: #999;">无权限</span>';
    }
    return `<button onclick="edit(${item.id})">编辑</button>`;
}
```

---

## 🔍 测试建议

### 测试步骤

1. **创建测试用户**
```sql
-- 管理员
INSERT INTO tb_user (username, password, role) VALUES ('admin', '加密密码', '管理员');
-- 仓库管理员
INSERT INTO tb_user (username, password, role) VALUES ('warehouse', '加密密码', '仓库管理员');
-- 教师
INSERT INTO tb_user (username, password, role) VALUES ('teacher', '加密密码', '教师');
-- 普通用户
INSERT INTO tb_user (username, password, role) VALUES ('user', '加密密码', '普通用户');
```

2. **测试场景**

#### 场景1：教材管理（普通用户）
- ✅ 登录普通用户
- ✅ 访问教材管理页面
- ✅ 检查"添加教材"按钮是否半透明
- ✅ 点击按钮，应弹出提示："只有管理员可以添加教材"
- ✅ 教材列表操作列显示"查看"而非"编辑/删除"

#### 场景2：订单管理（教师）
- ✅ 登录教师账号
- ✅ 访问订单管理页面
- ✅ "创建订单"按钮正常显示
- ✅ 订单列表只显示自己的订单
- ✅ 待审核订单有"取消"按钮，但没有"审核"按钮

#### 场景3：统计报表（普通用户）
- ✅ 登录普通用户
- ✅ 访问统计报表页面
- ✅ 页面顶部显示黄色提示横幅："您当前是普通用户角色，统计报表功能需要教师及以上角色才能访问"
- ✅ 所有表格显示："您没有权限查看此报表"

#### 场景4：仪表盘（仓库管理员）
- ✅ 登录仓库管理员
- ✅ 访问仪表盘
- ✅ 基础统计卡片正常显示
- ✅ 库存预警表格正常显示数据

---

## 📝 技术要点

### 1. 权限信息存储
用户登录后，权限信息存储在 `localStorage` 中：
```javascript
localStorage.setItem('user', JSON.stringify({
    username: 'xxx',
    role: '管理员',
    real_name: 'xxx'
}));
```

### 2. 权限检查时机
- **页面加载时**：`window.addEventListener('load', ...)`
- **数据加载前**：在API调用前检查
- **用户操作时**：点击按钮/链接前检查
- **动态渲染时**：列表渲染时根据权限生成不同HTML

### 3. 友好提示方式
- **按钮半透明** + **cursor: not-allowed**
- **弹出消息提示**：`showMessage('xxx', 'warning')`
- **表格内提示**：灰色文字提示权限不足
- **页面横幅提示**：黄色警告框

### 4. 403错误处理
```javascript
try {
    const result = await api.someAction();
} catch (error) {
    if (error.message && error.message.includes('403')) {
        showMessage('您没有权限执行此操作', 'warning');
    } else {
        handleError(error);
    }
}
```

---

## 🎯 总结

### 实施效果

✅ **用户体验大幅提升**：权限不足在前端就能看到，不会产生困惑  
✅ **界面更加友好**：半透明按钮、提示文字、弹窗提示  
✅ **安全性不降低**：后端依然有权限验证，前端只是增强体验  
✅ **代码可维护**：权限检查函数统一管理，易于扩展  

### 改进建议

1. **可以考虑增加角色徽章**：在用户信息区显示角色标签
2. **可以增加权限说明页面**：让用户了解各角色的权限
3. **可以记录用户尝试无权限操作**：用于审计和安全分析

---

**文档更新日期**: 2026-01-10  
**维护人员**: AI Assistant
