# é«˜æ ¡æ•™æç®¡ç†ç³»ç»Ÿ - æƒé™ç®¡ç†è§„åˆ’ä¸ERå›¾ (v2.0)

> **ç‰ˆæœ¬è¯´æ˜**ï¼šæœ¬ç‰ˆæœ¬ä¿®æ­£äº†è®¢å•ç®¡ç†çš„æ•°æ®æƒé™è§„åˆ™ï¼Œæ˜ç¡®äº†æ™®é€šç”¨æˆ·å’Œæ•™å¸ˆç”¨æˆ·çš„æƒé™è¾¹ç•Œã€‚

## ä¸€ã€æ•°æ®åº“E-Rå›¾ï¼ˆå®ä½“å…³ç³»å›¾ï¼‰

### 1.1 æ ¸å¿ƒå®ä½“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ· (User)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK: user_id     â”‚
â”‚ username â­     â”‚  â† å”¯ä¸€æ ‡è¯†ï¼Œç”¨äºæƒé™åˆ¤æ–­
â”‚ password        â”‚
â”‚ real_name       â”‚
â”‚ role â­         â”‚
â”‚ department      â”‚
â”‚ email           â”‚
â”‚ phone           â”‚
â”‚ last_login      â”‚
â”‚ status          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ æ“ä½œ/å®¡æ‰¹
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚å‡ºç‰ˆç¤¾         â”‚   â”‚æ•™æç±»å‹      â”‚   â”‚  æ•™æ        â”‚â”‚
â”‚  â”‚(Publisher)   â”‚   â”‚(TextbookType)â”‚   â”‚(Textbook)    â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚PK:publisher_idâ”‚  â”‚PK:type_id    â”‚   â”‚PK:textbook_idâ”‚â”‚
â”‚  â”‚publisher_nameâ”‚   â”‚type_name     â”‚   â”‚isbn          â”‚â”‚
â”‚  â”‚contact_personâ”‚   â”‚type_code     â”‚   â”‚textbook_name â”‚â”‚
â”‚  â”‚contact_phone â”‚   â”‚description   â”‚   â”‚author        â”‚â”‚
â”‚  â”‚address       â”‚   â”‚parent_id FK  â”‚   â”‚publisher_id FKâ”‚
â”‚  â”‚email         â”‚   â”‚status        â”‚   â”‚type_id FK    â”‚â”‚
â”‚  â”‚status        â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚edition       â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚           â”‚price         â”‚â”‚
â”‚         â”‚                  â”‚           â”‚description   â”‚â”‚
â”‚         â”‚                  â”‚           â”‚status        â”‚â”‚
â”‚         â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
                            â”‚                             
                            â–¼                             
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           
        â”‚     åº“å­˜ (Inventory)               â”‚           
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           
        â”‚ PK: inventory_id                   â”‚           
        â”‚ FK: textbook_id (UNIQUE)           â”‚           
        â”‚ current_quantity                   â”‚           
        â”‚ total_in_quantity                  â”‚           
        â”‚ total_out_quantity                 â”‚           
        â”‚ min_quantity                       â”‚           
        â”‚ max_quantity                       â”‚           
        â”‚ last_in_date                       â”‚           
        â”‚ last_out_date                      â”‚           
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           
                    â–²           â–²                         
                    â”‚           â”‚                         
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          
        â”‚                                      â”‚          
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å…¥åº“            â”‚                  â”‚   é¢†ç”¨            â”‚
â”‚  (StockIn)       â”‚                  â”‚ (Requisition)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚PK: stock_in_id   â”‚                  â”‚PK:requisition_id â”‚
â”‚stock_in_no       â”‚                  â”‚requisition_no    â”‚
â”‚order_id FK       â”‚                  â”‚textbook_id FK    â”‚
â”‚textbook_id FK    â”‚                  â”‚requisition_qty   â”‚
â”‚stock_in_quantity â”‚                  â”‚requisition_date  â”‚
â”‚stock_in_date     â”‚                  â”‚department        â”‚
â”‚warehouse_person  â”‚                  â”‚requisition_personâ”‚
â”‚quality_status    â”‚                  â”‚requisition_purposeâ”‚
â”‚actual_quantity   â”‚                  â”‚approver          â”‚
â”‚remarks           â”‚                  â”‚approval_statusâ­ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚actual_quantity   â”‚
        â–²                             â”‚remarks           â”‚
        â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                                 
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     
â”‚   è®¢è´­            â”‚                                     
â”‚(PurchaseOrder)   â”‚                                     
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                     
â”‚PK: order_id      â”‚                                     
â”‚order_no          â”‚                                     
â”‚textbook_id FK    â”‚                                     
â”‚order_quantity    â”‚                                     
â”‚order_date        â”‚                                     
â”‚expected_date     â”‚                                     
â”‚order_person â­   â”‚  â† å­˜å‚¨ç”¨æˆ·çš„ usernameï¼ˆé real_nameï¼‰
â”‚order_status â­   â”‚                                     
â”‚arrived_quantity  â”‚                                     
â”‚remarks           â”‚                                     
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     
```

### 1.2 å®ä½“å…³ç³»è¯´æ˜

1. **ç”¨æˆ· (User)** æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œæ‰€æœ‰æ“ä½œéƒ½ç”±ç”¨æˆ·å‘èµ·
2. **å‡ºç‰ˆç¤¾ (Publisher)** 1:N **æ•™æ (Textbook)**
3. **æ•™æç±»å‹ (TextbookType)** 1:N **æ•™æ (Textbook)**
4. **æ•™æ (Textbook)** 1:1 **åº“å­˜ (Inventory)** ï¼ˆé€šè¿‡è§¦å‘å™¨è‡ªåŠ¨åˆ›å»ºï¼‰
5. **æ•™æ (Textbook)** 1:N **è®¢è´­å• (PurchaseOrder)**
6. **è®¢è´­å• (PurchaseOrder)** 1:N **å…¥åº“å• (StockIn)**
7. **æ•™æ (Textbook)** 1:N **é¢†ç”¨å• (Requisition)**
8. **å…¥åº“å• (StockIn)** â†’ è§¦å‘å™¨è‡ªåŠ¨æ›´æ–° **åº“å­˜ (Inventory)**
9. **é¢†ç”¨å• (Requisition)** â†’ è§¦å‘å™¨è‡ªåŠ¨æ›´æ–° **åº“å­˜ (Inventory)**

### 1.3 å…³é”®çº¦æŸ

- **order_person** å­—æ®µå­˜å‚¨çš„æ˜¯ç”¨æˆ·çš„ `username`ï¼ˆç”¨æˆ·åï¼‰ï¼Œè€Œé `real_name`ï¼ˆçœŸå®å§“åï¼‰
- æ•™æåˆ é™¤æ—¶ï¼Œå¿…é¡»ä¿æŠ¤è®¢è´­å•ã€å…¥åº“å•ã€é¢†ç”¨å•çš„æ•°æ®å®Œæ•´æ€§ (RESTRICT)
- åº“å­˜æ•°é‡ä¸èƒ½ä¸ºè´Ÿæ•°
- å…¥åº“æ—¶è‡ªåŠ¨æ›´æ–°è®¢å•çŠ¶æ€ï¼ˆå·²åˆ°è´§/éƒ¨åˆ†åˆ°è´§ï¼‰
- é¢†ç”¨å‘æ”¾æ—¶æ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³

---

## äºŒã€è§’è‰²æƒé™çŸ©é˜µï¼ˆv2.0 ä¿®æ­£ç‰ˆï¼‰

### 2.1 è§’è‰²å®šä¹‰

ç³»ç»Ÿå®šä¹‰4ç§è§’è‰²ï¼š
1. **ç®¡ç†å‘˜** - ç³»ç»Ÿæœ€é«˜æƒé™ï¼Œç®¡ç†æ‰€æœ‰æ•°æ®å’Œç”¨æˆ·
2. **ä»“åº“ç®¡ç†å‘˜** - è´Ÿè´£å…¥åº“ã€å‡ºåº“ã€åº“å­˜ç®¡ç†ï¼Œå¯ä¸ºä»»ä½•äººåˆ›å»ºè®¢å•
3. **æ•™å¸ˆ** - å¯ä»¥ä¸ºè‡ªå·±æˆ–æ™®é€šç”¨æˆ·åˆ›å»ºè®¢å•ã€æŸ¥çœ‹ç›¸å…³è®¢å•
4. **æ™®é€šç”¨æˆ·** - åªèƒ½ä¸ºè‡ªå·±åˆ›å»ºè®¢å•ã€æŸ¥çœ‹è‡ªå·±çš„è®¢å•

### 2.2 æƒé™çŸ©é˜µè¡¨ï¼ˆè®¢å•ç®¡ç†éƒ¨åˆ†å·²ä¿®æ­£ âš ï¸ï¼‰

| åŠŸèƒ½æ¨¡å— | æ“ä½œ | ç®¡ç†å‘˜ | ä»“åº“ç®¡ç†å‘˜ | æ•™å¸ˆ | æ™®é€šç”¨æˆ· |
|---------|------|--------|-----------|------|----------|
| **ç”¨æˆ·ç®¡ç†** |
| | æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨ | âœ… | âŒ | âŒ | âŒ |
| | åˆ›å»ºç”¨æˆ· | âœ… | âŒ | âŒ | âŒ |
| | ç¼–è¾‘ç”¨æˆ· | âœ… | âŒ | âŒ | âŒ |
| | åˆ é™¤/åœç”¨ç”¨æˆ· | âœ… | âŒ | âŒ | âŒ |
| | æŸ¥çœ‹ä¸ªäººä¿¡æ¯ | âœ… | âœ… | âœ… | âœ… |
| **å‡ºç‰ˆç¤¾ç®¡ç†** |
| | æŸ¥çœ‹å‡ºç‰ˆç¤¾åˆ—è¡¨ | âœ… | âœ… | âœ… | âœ… |
| | æŸ¥çœ‹å‡ºç‰ˆç¤¾è¯¦æƒ… | âœ… | âœ… | âœ… | âœ… |
| | åˆ›å»ºå‡ºç‰ˆç¤¾ | âœ… | âŒ | âŒ | âŒ |
| | ç¼–è¾‘å‡ºç‰ˆç¤¾ | âœ… | âŒ | âŒ | âŒ |
| | åˆ é™¤å‡ºç‰ˆç¤¾ | âœ… | âŒ | âŒ | âŒ |
| **æ•™æç±»å‹ç®¡ç†** |
| | æŸ¥çœ‹ç±»å‹åˆ—è¡¨ | âœ… | âœ… | âœ… | âœ… |
| | åˆ›å»ºç±»å‹ | âœ… | âŒ | âŒ | âŒ |
| | ç¼–è¾‘ç±»å‹ | âœ… | âŒ | âŒ | âŒ |
| | åˆ é™¤ç±»å‹ | âœ… | âŒ | âŒ | âŒ |
| **æ•™æç®¡ç†** |
| | æŸ¥çœ‹æ•™æåˆ—è¡¨ | âœ… | âœ… | âœ… | âœ… |
| | æŸ¥çœ‹æ•™æè¯¦æƒ… | âœ… | âœ… | âœ… | âœ… |
| | åˆ›å»ºæ•™æ | âœ… | âŒ | âŒ | âŒ |
| | ç¼–è¾‘æ•™æ | âœ… | âŒ | âŒ | âŒ |
| | åˆ é™¤æ•™æ | âœ… | âŒ | âŒ | âŒ |
| **è®¢è´­ç®¡ç†** âš ï¸ ä¿®æ­£ |
| | æŸ¥çœ‹è®¢å•åˆ—è¡¨ | âœ… å…¨éƒ¨ | âœ… å…¨éƒ¨ | âœ… è‡ªå·±+æ™®é€šç”¨æˆ·çš„ | âœ… ä»…è‡ªå·±çš„ |
| | æŸ¥çœ‹è®¢å•è¯¦æƒ… | âœ… | âœ… | âœ… è‡ªå·±+æ™®é€šç”¨æˆ·çš„ | âœ… ä»…è‡ªå·±çš„ |
| | åˆ›å»ºè®¢å• | âœ… ä»»ä½•äºº | âœ… ä»»ä½•äºº | âœ… è‡ªå·±+æ™®é€šç”¨æˆ· | âœ… ä»…è‡ªå·± |
| | ç¼–è¾‘è®¢å• | âœ… | âœ… | âœ… è‡ªå·±çš„å¾…å®¡æ ¸ | âœ… è‡ªå·±çš„å¾…å®¡æ ¸ |
| | å®¡æ ¸è®¢å• | âœ… | âœ… | âŒ | âŒ |
| | å–æ¶ˆè®¢å• | âœ… | âœ… | âœ… è‡ªå·±+æ™®é€šç”¨æˆ·çš„å¾…å®¡æ ¸ | âœ… è‡ªå·±çš„å¾…å®¡æ ¸ |
| **å…¥åº“ç®¡ç†** |
| | æŸ¥çœ‹å…¥åº“åˆ—è¡¨ | âœ… | âœ… | âŒ | âŒ |
| | æŸ¥çœ‹å…¥åº“è¯¦æƒ… | âœ… | âœ… | âŒ | âŒ |
| | åˆ›å»ºå…¥åº“å• | âœ… | âœ… | âŒ | âŒ |
| | ç¼–è¾‘å…¥åº“å• | âœ… | âœ… | âŒ | âŒ |
| | åˆ é™¤å…¥åº“å• | âœ… | âŒ | âŒ | âŒ |
| **é¢†ç”¨ç®¡ç†** |
| | æŸ¥çœ‹é¢†ç”¨åˆ—è¡¨ | âœ… | âœ… | âœ… (ä»…è‡ªå·±çš„) | âœ… (ä»…è‡ªå·±çš„) |
| | æŸ¥çœ‹é¢†ç”¨è¯¦æƒ… | âœ… | âœ… | âœ… (ä»…è‡ªå·±çš„) | âœ… (ä»…è‡ªå·±çš„) |
| | åˆ›å»ºé¢†ç”¨ç”³è¯· | âœ… | âœ… | âœ… | âœ… |
| | ç¼–è¾‘é¢†ç”¨ç”³è¯· | âœ… | âœ… | âœ… (å¾…å®¡æ‰¹çŠ¶æ€) | âœ… (å¾…å®¡æ‰¹çŠ¶æ€) |
| | å–æ¶ˆé¢†ç”¨ç”³è¯· | âœ… | âœ… | âœ… (å¾…å®¡æ‰¹çŠ¶æ€) | âœ… (å¾…å®¡æ‰¹çŠ¶æ€) |
| | å®¡æ‰¹é¢†ç”¨ç”³è¯· | âœ… | âœ… | âŒ | âŒ |
| | å‘æ”¾æ•™æ | âœ… | âœ… | âŒ | âŒ |
| **åº“å­˜ç®¡ç†** |
| | æŸ¥çœ‹åº“å­˜åˆ—è¡¨ | âœ… | âœ… | âœ… (åªè¯») | âœ… (åªè¯») |
| | æŸ¥çœ‹åº“å­˜è¯¦æƒ… | âœ… | âœ… | âœ… | âœ… |
| | åº“å­˜é¢„è­¦æŸ¥è¯¢ | âœ… | âœ… | âŒ | âŒ |
| | è°ƒæ•´åº“å­˜é˜ˆå€¼ | âœ… | âœ… | âŒ | âŒ |
| **ç»Ÿè®¡æŠ¥è¡¨** |
| | æŒ‰ç±»å‹ç»Ÿè®¡ | âœ… | âœ… | âœ… | âŒ |
| | æŒ‰å‡ºç‰ˆç¤¾ç»Ÿè®¡ | âœ… | âœ… | âœ… | âŒ |
| | æŒ‰æ•™æç»Ÿè®¡ | âœ… | âœ… | âœ… | âŒ |
| | æŒ‰æ—¥æœŸèŒƒå›´ç»Ÿè®¡ | âœ… | âœ… | âœ… | âŒ |
| | åº“å­˜é¢„è­¦æŠ¥è¡¨ | âœ… | âœ… | âŒ | âŒ |

### 2.3 è®¢å•ç®¡ç†æƒé™è¯¦è§£ï¼ˆv2.0 æ ¸å¿ƒä¿®æ­£ï¼‰

#### ğŸ“Œ æ™®é€šç”¨æˆ·è®¢å•æƒé™

| æ“ä½œ | æƒé™è§„åˆ™ |
|------|---------|
| **æŸ¥çœ‹è®¢å•åˆ—è¡¨** | åªèƒ½çœ‹åˆ° `order_person` = è‡ªå·±ç”¨æˆ·å çš„è®¢å• |
| **æŸ¥çœ‹è®¢å•è¯¦æƒ…** | åªèƒ½çœ‹åˆ° `order_person` = è‡ªå·±ç”¨æˆ·å çš„è®¢å• |
| **åˆ›å»ºè®¢å•** | åªèƒ½åˆ›å»º `order_person` = è‡ªå·±ç”¨æˆ·å çš„è®¢å• |
| **ç¼–è¾‘è®¢å•** | åªèƒ½ç¼–è¾‘ `order_person` = è‡ªå·±ç”¨æˆ·å ä¸”çŠ¶æ€ä¸º"å¾…å®¡æ ¸"çš„è®¢å• |
| **å–æ¶ˆè®¢å•** | åªèƒ½å–æ¶ˆ `order_person` = è‡ªå·±ç”¨æˆ·å ä¸”çŠ¶æ€ä¸º"å¾…å®¡æ ¸"çš„è®¢å• |

#### ğŸ“Œ æ•™å¸ˆç”¨æˆ·è®¢å•æƒé™

| æ“ä½œ | æƒé™è§„åˆ™ |
|------|---------|
| **æŸ¥çœ‹è®¢å•åˆ—è¡¨** | å¯ä»¥çœ‹åˆ° `order_person` = è‡ªå·± **æˆ–** `order_person` æ˜¯æ™®é€šç”¨æˆ· çš„è®¢å• |
| **æŸ¥çœ‹è®¢å•è¯¦æƒ…** | å¯ä»¥çœ‹åˆ° `order_person` = è‡ªå·± **æˆ–** `order_person` æ˜¯æ™®é€šç”¨æˆ· çš„è®¢å• |
| **åˆ›å»ºè®¢å•** | å¯ä»¥ä¸ºè‡ªå·±æˆ–æ™®é€šç”¨æˆ·åˆ›å»ºè®¢å•ï¼ˆä¸‹æ‹‰æ¡†æ˜¾ç¤ºè‡ªå·±+æ‰€æœ‰æ™®é€šç”¨æˆ·ï¼‰ |
| **ç¼–è¾‘è®¢å•** | åªèƒ½ç¼–è¾‘ `order_person` = è‡ªå·± ä¸”çŠ¶æ€ä¸º"å¾…å®¡æ ¸"çš„è®¢å• |
| **å–æ¶ˆè®¢å•** | å¯ä»¥å–æ¶ˆ `order_person` = è‡ªå·± **æˆ–** `order_person` æ˜¯æ™®é€šç”¨æˆ· ä¸”çŠ¶æ€ä¸º"å¾…å®¡æ ¸"çš„è®¢å• |

#### ğŸ“Œ ç®¡ç†å‘˜/ä»“åº“ç®¡ç†å‘˜è®¢å•æƒé™

| æ“ä½œ | æƒé™è§„åˆ™ |
|------|---------|
| **æŸ¥çœ‹è®¢å•åˆ—è¡¨** | å¯ä»¥çœ‹åˆ°æ‰€æœ‰è®¢å• |
| **æŸ¥çœ‹è®¢å•è¯¦æƒ…** | å¯ä»¥çœ‹åˆ°æ‰€æœ‰è®¢å• |
| **åˆ›å»ºè®¢å•** | å¯ä»¥ä¸ºä»»ä½•ç”¨æˆ·åˆ›å»ºè®¢å•ï¼ˆä¸‹æ‹‰æ¡†æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·ï¼‰ |
| **ç¼–è¾‘è®¢å•** | å¯ä»¥ç¼–è¾‘ä»»ä½•è®¢å• |
| **å®¡æ ¸è®¢å•** | å¯ä»¥å®¡æ ¸ä»»ä½•"å¾…å®¡æ ¸"çŠ¶æ€çš„è®¢å• |
| **å–æ¶ˆè®¢å•** | å¯ä»¥å–æ¶ˆä»»ä½•é"å·²åˆ°è´§"/"å·²å–æ¶ˆ"çŠ¶æ€çš„è®¢å• |

### 2.4 åˆ›å»ºè®¢å•æ—¶çš„è®¢è´­äººä¸‹æ‹‰æ¡†è§„åˆ™

| è§’è‰² | ä¸‹æ‹‰æ¡†æ˜¾ç¤ºå†…å®¹ | è¯´æ˜ |
|-----|--------------|------|
| **ç®¡ç†å‘˜** | æ‰€æœ‰ç”¨æˆ· | å¯ä»¥ä¸ºä»»ä½•äººåˆ›å»ºè®¢å• |
| **ä»“åº“ç®¡ç†å‘˜** | æ‰€æœ‰ç”¨æˆ· | å¯ä»¥ä¸ºä»»ä½•äººåˆ›å»ºè®¢å• |
| **æ•™å¸ˆ** | è‡ªå·± + æ‰€æœ‰æ™®é€šç”¨æˆ· | å¯ä»¥ä¸ºè‡ªå·±æˆ–æ™®é€šç”¨æˆ·åˆ›å»ºè®¢å• |
| **æ™®é€šç”¨æˆ·** | ä»…è‡ªå·± | åªèƒ½ä¸ºè‡ªå·±åˆ›å»ºè®¢å•ï¼ˆä¸‹æ‹‰æ¡†é”å®šï¼‰ |

---

## ä¸‰ã€æŠ€æœ¯å®ç°è¦ç‚¹ï¼ˆv2.0 ä¿®æ­£ï¼‰

### 3.1 JWT Token ç»“æ„

```python
# ç™»å½•æ—¶ç”Ÿæˆçš„ JWT Token ç»“æ„
{
    "sub": "1",           # user_idï¼ˆå­—ç¬¦ä¸²æ ¼å¼ï¼‰
    "username": "user01", # ç”¨æˆ·å â­ ç”¨äºæƒé™åˆ¤æ–­
    "role": "æ™®é€šç”¨æˆ·",   # è§’è‰²
    "real_name": "å¼ ä¸‰"   # çœŸå®å§“å
}
```

### 3.2 è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯çš„æ­£ç¡®æ–¹å¼

```python
from flask_jwt_extended import get_jwt

current_user = get_jwt()

# âŒ é”™è¯¯å†™æ³•ï¼šsub æ˜¯ user_idï¼Œä¸æ˜¯ username
username = current_user.get('sub')  

# âœ… æ­£ç¡®å†™æ³•ï¼šä» additional_claims è·å– username
username = current_user.get('username')
role = current_user.get('role')
real_name = current_user.get('real_name')
```

### 3.3 è®¢å•æ•°æ®æƒé™è¿‡æ»¤ç¤ºä¾‹

```python
# è·å–è®¢å•åˆ—è¡¨æ—¶çš„æ•°æ®æƒé™è¿‡æ»¤
if role == 'æ™®é€šç”¨æˆ·':
    # æ™®é€šç”¨æˆ·åªèƒ½æŸ¥çœ‹ order_person = è‡ªå·±çš„è®¢å•
    order_person = username
elif role == 'æ•™å¸ˆ':
    # æ•™å¸ˆå¯ä»¥æŸ¥çœ‹ order_person = è‡ªå·± æˆ– æ™®é€šç”¨æˆ· çš„è®¢å•
    allowed_roles = ['æ•™å¸ˆ', 'æ™®é€šç”¨æˆ·']
    current_username = username
# ç®¡ç†å‘˜å’Œä»“åº“ç®¡ç†å‘˜ä¸è®¾é™åˆ¶
```

### 3.4 è®¢è´­äººä¸‹æ‹‰æ¡† API è¿”å›è§„åˆ™

```python
@api_v1.route('/auth/users', methods=['GET'])
@jwt_required()
def get_users():
    """è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆç”¨äºè®¢è´­äººä¸‹æ‹‰é€‰æ‹©ï¼‰"""
    if user_role in ['ç®¡ç†å‘˜', 'ä»“åº“ç®¡ç†å‘˜']:
        # è¿”å›æ‰€æœ‰ç”¨æˆ·
        users = user_dao.get_all_users()
    elif user_role == 'æ•™å¸ˆ':
        # è¿”å›è‡ªå·± + æ‰€æœ‰æ™®é€šç”¨æˆ·
        users = [self] + get_users_by_role('æ™®é€šç”¨æˆ·')
    else:
        # æ™®é€šç”¨æˆ·åªè¿”å›è‡ªå·±
        users = [self]
```

---

## å››ã€è§¦å‘å™¨å’Œå­˜å‚¨è¿‡ç¨‹ä½¿ç”¨æƒ…å†µ

### 4.1 è§¦å‘å™¨ï¼ˆå·²è‡ªåŠ¨ç”Ÿæ•ˆï¼‰

| è§¦å‘å™¨åç§° | è§¦å‘æ—¶æœº | ä½œç”¨ | ä»£ç ä¸­çš„ä½“ç° |
|-----------|---------|------|-------------|
| `trg_textbook_after_insert` | æ’å…¥æ•™æå | è‡ªåŠ¨åˆ›å»ºåº“å­˜è®°å½• | åˆ›å»ºæ•™ææ—¶è‡ªåŠ¨åˆå§‹åŒ–åº“å­˜ä¸º0 |
| `trg_stock_in_after_insert` | æ’å…¥å…¥åº“è®°å½•å | è‡ªåŠ¨æ›´æ–°åº“å­˜å’Œè®¢å•çŠ¶æ€ | å…¥åº“æ“ä½œä¼šè‡ªåŠ¨å¢åŠ åº“å­˜ |
| `trg_requisition_after_update` | æ›´æ–°é¢†ç”¨è®°å½•å | é¢†ç”¨å‘æ”¾æ—¶è‡ªåŠ¨å‡å°‘åº“å­˜ | å®¡æ‰¹é€šè¿‡å¹¶å‘æ”¾æ—¶è‡ªåŠ¨æ‰£å‡åº“å­˜ |
| `trg_stock_in_before_delete` | åˆ é™¤å…¥åº“è®°å½•å‰ | å›é€€åº“å­˜å’Œè®¢å•æ•°é‡ | åˆ é™¤å…¥åº“å•æ—¶è‡ªåŠ¨å›é€€ |
| `trg_purchase_order_before_update` | æ›´æ–°è®¢å•å‰ | é˜²æ­¢å·²å–æ¶ˆè®¢å•è¢«ä¿®æ”¹ | ä¿æŠ¤æ•°æ®å®Œæ•´æ€§ |

### 4.2 å­˜å‚¨è¿‡ç¨‹ï¼ˆéœ€è¦åœ¨Pythonä¸­è°ƒç”¨ï¼‰

| å­˜å‚¨è¿‡ç¨‹åç§° | åŠŸèƒ½ | å½“å‰ä½¿ç”¨æƒ…å†µ | ä½ç½® |
|-------------|------|-------------|------|
| `sp_statistics_by_type()` | æŒ‰æ•™æç±»å‹ç»Ÿè®¡ | âœ… å·²ä½¿ç”¨ | `statistics_service.py` |
| `sp_statistics_by_publisher()` | æŒ‰å‡ºç‰ˆç¤¾ç»Ÿè®¡ | âœ… å·²ä½¿ç”¨ | `statistics_service.py` |
| `sp_statistics_by_textbook(id)` | æŒ‰æ•™æç»Ÿè®¡ | âœ… å·²ä½¿ç”¨ | `statistics_service.py` |
| `sp_statistics_by_date_range(start, end)` | æŒ‰æ—¥æœŸèŒƒå›´ç»Ÿè®¡ | âœ… å·²ä½¿ç”¨ | `statistics_service.py` |
| `sp_inventory_warning()` | åº“å­˜é¢„è­¦æŸ¥è¯¢ | âœ… å·²ä½¿ç”¨ | `statistics_service.py` |
| `sp_generate_order_no()` | ç”Ÿæˆè®¢å•ç¼–å· | âœ… å·²ä½¿ç”¨ | `purchase_service.py` |
| `sp_generate_stock_in_no()` | ç”Ÿæˆå…¥åº“å•å· | âš ï¸ å¾…å®ç° | - |
| `sp_generate_requisition_no()` | ç”Ÿæˆé¢†ç”¨å•å· | âš ï¸ å¾…å®ç° | - |

---

## äº”ã€v2.0 ä¿®å¤æ¸…å•

### 5.1 å·²ä¿®å¤çš„é—®é¢˜

| é—®é¢˜ | åŸå›  | ä¿®å¤æ–¹æ¡ˆ |
|-----|------|---------|
| æ™®é€šç”¨æˆ·çœ‹ä¸åˆ°è‡ªå·±çš„è®¢å• | `get('sub')` è·å–çš„æ˜¯ user_id è€Œé username | æ”¹ä¸º `get('username')` |
| æ•™å¸ˆçœ‹ä¸åˆ°è‡ªå·±çš„è®¢å• | åŒä¸Š | æ”¹ä¸º `get('username')` |
| æ™®é€šç”¨æˆ·åˆ›å»ºè®¢å•æ—¶çœ‹ä¸åˆ°è‡ªå·± | get_users API ä½¿ç”¨äº†é”™è¯¯çš„ username | ä¿®å¤ `get('username')` |
| æ•™å¸ˆåˆ›å»ºè®¢å•æ—¶çœ‹ä¸åˆ°è‡ªå·± | åŒä¸Š | ä¿®å¤ `get('username')` |
| æ•™å¸ˆæ— æ³•å–æ¶ˆæ™®é€šç”¨æˆ·çš„è®¢å• | å–æ¶ˆè®¢å•æƒé™æ£€æŸ¥ä¸å®Œæ•´ | å¢åŠ æ•™å¸ˆå–æ¶ˆæ™®é€šç”¨æˆ·è®¢å•çš„é€»è¾‘ |

### 5.2 ä¿®æ”¹çš„æ–‡ä»¶

1. `app/api/v1/purchase_order.py` - æ‰€æœ‰ `get('sub')` æ”¹ä¸º `get('username')`
2. `app/api/v1/auth.py` - `get_users` å‡½æ•°ä¿®å¤ username è·å–
3. `app/templates/orders.html` - å–æ¶ˆæŒ‰é’®æƒé™åˆ¤æ–­ä¿®å¤

---

## å…­ã€æµ‹è¯•æ£€æŸ¥æ¸…å•ï¼ˆv2.0ï¼‰

### 6.1 æ™®é€šç”¨æˆ·æµ‹è¯•

- [ ] ç™»å½•åèƒ½çœ‹åˆ°è®¢å•ç®¡ç†èœå•
- [ ] è®¢å•åˆ—è¡¨åªæ˜¾ç¤º order_person æ˜¯è‡ªå·±çš„è®¢å•
- [ ] åˆ›å»ºè®¢å•æ—¶ï¼Œè®¢è´­äººä¸‹æ‹‰æ¡†åªæœ‰è‡ªå·±ä¸”è¢«é”å®š
- [ ] èƒ½æˆåŠŸåˆ›å»º order_person æ˜¯è‡ªå·±çš„è®¢å•
- [ ] ä¸èƒ½åˆ›å»º order_person æ˜¯å…¶ä»–äººçš„è®¢å•
- [ ] åªèƒ½å–æ¶ˆè‡ªå·±çš„å¾…å®¡æ ¸è®¢å•
- [ ] ä¸èƒ½å®¡æ ¸è®¢å•

### 6.2 æ•™å¸ˆç”¨æˆ·æµ‹è¯•

- [ ] è®¢å•åˆ—è¡¨æ˜¾ç¤º order_person æ˜¯è‡ªå·± **æˆ–** æ™®é€šç”¨æˆ·çš„è®¢å•
- [ ] åˆ›å»ºè®¢å•æ—¶ï¼Œè®¢è´­äººä¸‹æ‹‰æ¡†åŒ…å«è‡ªå·±å’Œæ‰€æœ‰æ™®é€šç”¨æˆ·
- [ ] èƒ½æˆåŠŸåˆ›å»º order_person æ˜¯è‡ªå·±çš„è®¢å•
- [ ] èƒ½æˆåŠŸåˆ›å»º order_person æ˜¯æ™®é€šç”¨æˆ·çš„è®¢å•
- [ ] ä¸èƒ½åˆ›å»º order_person æ˜¯å…¶ä»–æ•™å¸ˆ/ç®¡ç†å‘˜çš„è®¢å•
- [ ] èƒ½å–æ¶ˆè‡ªå·±æˆ–æ™®é€šç”¨æˆ·çš„å¾…å®¡æ ¸è®¢å•
- [ ] ä¸èƒ½å–æ¶ˆå…¶ä»–æ•™å¸ˆçš„è®¢å•
- [ ] ä¸èƒ½å®¡æ ¸è®¢å•

### 6.3 ç®¡ç†å‘˜/ä»“åº“ç®¡ç†å‘˜æµ‹è¯•

- [ ] è®¢å•åˆ—è¡¨æ˜¾ç¤ºæ‰€æœ‰è®¢å•
- [ ] åˆ›å»ºè®¢å•æ—¶ï¼Œè®¢è´­äººä¸‹æ‹‰æ¡†åŒ…å«æ‰€æœ‰ç”¨æˆ·
- [ ] èƒ½ä¸ºä»»ä½•äººåˆ›å»ºè®¢å•
- [ ] èƒ½å®¡æ ¸ä»»ä½•å¾…å®¡æ ¸è®¢å•
- [ ] èƒ½å–æ¶ˆä»»ä½•æœªå®Œæˆè®¢å•

---

## ä¸ƒã€æ€»ç»“

### v2.0 æ ¸å¿ƒå˜æ›´

1. **ä¿®æ­£ JWT ç”¨æˆ·åè·å–**ï¼š`get('sub')` â†’ `get('username')`
2. **æ˜ç¡®è®¢å•æ•°æ®æƒé™è¾¹ç•Œ**ï¼š
   - æ™®é€šç”¨æˆ·ï¼šåªèƒ½æ“ä½œè‡ªå·±çš„è®¢å•
   - æ•™å¸ˆï¼šå¯ä»¥æ“ä½œè‡ªå·±å’Œæ™®é€šç”¨æˆ·çš„è®¢å•
   - ç®¡ç†å‘˜/ä»“åº“ç®¡ç†å‘˜ï¼šæ— é™åˆ¶
3. **å®Œå–„å–æ¶ˆè®¢å•æƒé™**ï¼šæ•™å¸ˆå¯ä»¥å–æ¶ˆæ™®é€šç”¨æˆ·çš„å¾…å®¡æ ¸è®¢å•

### æƒé™æ§åˆ¶æ ¸å¿ƒæ€æƒ³

1. **è§’è‰²åˆ†ç¦»**ï¼šä¸åŒè§’è‰²æœ‰æ˜ç¡®çš„èŒè´£è¾¹ç•Œ
2. **æœ€å°æƒé™åŸåˆ™**ï¼šåªç»™å¿…è¦çš„æƒé™ï¼Œé™ä½è¯¯æ“ä½œé£é™©
3. **æ•°æ®éš”ç¦»**ï¼šåŸºäº `order_person` å­—æ®µè¿›è¡Œæ•°æ®æƒé™éš”ç¦»
4. **å±‚çº§æ§åˆ¶**ï¼šæ•™å¸ˆå¯ä»¥ç®¡ç†æ™®é€šç”¨æˆ·ï¼Œä½†ä¸èƒ½è¶Šçº§ç®¡ç†

---

**æ–‡æ¡£ç‰ˆæœ¬**: 2.0  
**æ›´æ–°æ—¥æœŸ**: 2026-01-10  
**ä¸»è¦å˜æ›´**: ä¿®æ­£è®¢å•ç®¡ç†æ•°æ®æƒé™è§„åˆ™  
**ç»´æŠ¤äºº**: AI Assistant
