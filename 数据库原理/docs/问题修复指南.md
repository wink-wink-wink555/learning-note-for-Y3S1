# 🔧 问题修复指南

## 问题诊断

您遇到的"服务器发生未知错误"和表格加载失败的问题，主要是因为：

### 1. ✅ 已修复：DAO层缺少参数支持

**问题：** DAO的search方法不支持新增的权限过滤参数
- `purchase_order_dao.py` - 缺少 `order_person` 参数
- `requisition_dao.py` - 缺少 `requisition_person` 参数

**已修复：**
- ✅ 添加了 `order_person` 参数用于教师只能查看自己的订单
- ✅ 添加了 `requisition_person` 参数用于普通用户只能查看自己的领用
- ✅ 添加了 `inventory_dao.py` 的 `get_by_textbook_id()` 方法别名

### 2. ⚠️ 需要操作：缺少Python依赖包

**问题：** `ModuleNotFoundError: No module named 'flask_cors'`

**解决方法：**

```bash
# 在项目目录下执行
pip install -r requirements.txt
```

或者单独安装缺失的包：
```bash
pip install Flask-CORS==4.0.0
```

---

## 🚀 立即修复步骤

### 步骤1：安装依赖包

在终端中执行：

```bash
cd D:\Pycharm\DatabaseProj
pip install -r requirements.txt
```

### 步骤2：重启服务器

```bash
python run.py
```

### 步骤3：检查服务器启动

您应该看到类似输出：

```
 * Running on http://127.0.0.1:5000
 * Debug mode: on
```

### 步骤4：刷新前端页面

- 打开浏览器访问 `http://127.0.0.1:5000`
- 登录后访问仪表盘、订单管理、统计报表

---

## 📝 修复内容详细说明

### 修改的文件

1. **app/dao/purchase_order_dao.py**
   - 在 `search()` 方法中添加了 `order_person` 参数
   - 支持按订购人过滤订单（教师只能看自己的）

2. **app/dao/requisition_dao.py**
   - 在 `search()` 方法中添加了 `requisition_person` 参数
   - 支持按领用人过滤记录（普通用户只能看自己的）

3. **app/dao/inventory_dao.py**
   - 添加了 `get_by_textbook_id()` 方法作为 `get_by_textbook()` 的别名

### 修改示例

#### 修改前（purchase_order_dao.py）：
```python
def search(self, keyword=None, status=None, start_date=None, end_date=None, 
           page=1, per_page=20):
    # ... 没有 order_person 参数
```

#### 修改后：
```python
def search(self, keyword=None, status=None, start_date=None, end_date=None, 
           order_person=None, page=1, per_page=20):
    # ...
    # 数据权限过滤：按订购人过滤
    if order_person:
        query = query.filter_by(order_person=order_person)
```

---

## 🧪 验证修复

### 1. 测试仪表盘加载

访问 `http://127.0.0.1:5000/dashboard`，应该能看到：
- 教材总数
- 待处理订单数
- 待审批领用数
- 库存总价值
- 库存预警数

### 2. 测试订单管理

- **管理员/仓库管理员**：应该能看到所有订单
- **教师**：只能看到自己创建的订单（order_person = 当前用户）

### 3. 测试统计报表

- **教师及以上**：可以查看统计数据
- **普通用户**：应该返回403权限错误

### 4. 测试前端编辑

尝试编辑教材、出版社等数据：
- **管理员**：应该可以成功编辑
- **教师/普通用户**：应该返回403权限错误

---

## 🔍 如何排查错误

### 查看后端日志

如果还有问题，查看控制台输出的错误信息：

```bash
# 启动服务器时会显示详细错误
python run.py
```

### 查看浏览器控制台

按 `F12` 打开浏览器开发者工具，查看：
- **Console** 标签：JavaScript错误
- **Network** 标签：API请求状态码和响应

### 常见错误排查

#### 错误1：403 Forbidden
```json
{
  "code": 403,
  "message": "需要以下角色之一：管理员"
}
```
**原因：**当前用户权限不足  
**解决：**使用具有相应权限的账号登录

#### 错误2：500 Internal Server Error
```json
{
  "code": 500,
  "message": "服务器发生未知错误"
}
```
**原因：**后端代码错误  
**解决：**查看服务器控制台的详细错误堆栈

#### 错误3：数据库连接错误
```
sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (2003, "Can't connect to MySQL server")
```
**原因：**MySQL服务未启动或连接配置错误  
**解决：**
1. 检查MySQL服务是否运行
2. 检查 `config.py` 中的数据库配置

---

## ✅ 测试权限控制

安装依赖后，按照 `docs/快速测试指南.md` 进行完整测试：

### 测试场景1：教师查看订单
```bash
# 1. 以教师身份登录
POST http://127.0.0.1:5000/api/v1/auth/login
{
  "username": "teacher",
  "password": "teacher123"
}

# 2. 查看订单列表（只能看到自己的）
GET http://127.0.0.1:5000/api/v1/purchase-orders
Authorization: Bearer <teacher_token>
```

### 测试场景2：普通用户查看领用
```bash
# 1. 以普通用户身份登录
POST http://127.0.0.1:5000/api/v1/auth/login
{
  "username": "user",
  "password": "user123"
}

# 2. 查看领用列表（只能看到自己的）
GET http://127.0.0.1:5000/api/v1/requisitions
Authorization: Bearer <user_token>
```

---

## 📋 完整检查清单

安装依赖并重启服务器后，检查以下功能：

- [ ] 服务器成功启动（无报错）
- [ ] 前端页面可以访问
- [ ] 登录功能正常
- [ ] 仪表盘数据加载成功
- [ ] 订单管理页面加载成功
- [ ] 统计报表页面加载成功
- [ ] 教师只能看到自己的订单
- [ ] 普通用户只能看到自己的领用
- [ ] 管理员可以看到所有数据
- [ ] 权限限制正常工作（403错误）

---

## 🆘 如果问题仍然存在

### 1. 检查Python版本
```bash
python --version
# 应该是 Python 3.8 或更高
```

### 2. 重新安装依赖
```bash
pip uninstall -r requirements.txt -y
pip install -r requirements.txt
```

### 3. 检查数据库连接

在MySQL Workbench中执行：
```sql
USE textbook_management;
SHOW TABLES;
-- 应该显示所有表
```

### 4. 提供详细错误信息

如果还有问题，请提供：
- 服务器控制台的完整错误堆栈
- 浏览器Network标签中失败请求的响应内容
- 正在使用的用户角色和操作

---

**最后更新：** 2026-01-10  
**状态：** DAO层已修复，需要安装依赖包
