# 高校教材管理系统 - 数据库对象说明

本文档说明项目中使用的存储过程、视图、触发器的实现方式、功能描述及调用位置。

---

## 一、存储过程 (Stored Procedures)

### 1.1 sp_statistics_by_type - 按类型统计 ✅ 已调用

**功能描述**：统计各教材类型的订购、到货、发放数量和当前库存。

**SQL定义位置**：`sql/04_create_procedures.sql`

**调用位置**：`app/services/statistics_service.py`

**调用方式**：
```python
# statistics_service.py - get_statistics_by_type 方法
result = db.session.execute(text("CALL sp_statistics_by_type()"))
rows = result.fetchall()
```

**返回字段**：
| 字段 | 说明 |
|------|------|
| 类型ID | 教材类型ID |
| 教材类型 | 类型名称 |
| 类型编码 | 类型编码 |
| 教材种类数 | 该类型下的教材数量 |
| 订购总数量 | 订购总数 |
| 到货总数量 | 已到货总数 |
| 发放总数量 | 已发放总数 |
| 当前库存总量 | 当前库存数量 |

---

### 1.2 sp_statistics_by_textbook - 按教材统计 ✅ 已调用

**功能描述**：根据教材ID统计该教材的订购、到货和发放情况。

**SQL定义位置**：`sql/04_create_procedures.sql`

**调用位置**：`app/services/statistics_service.py`

**调用方式**：
```python
# statistics_service.py - get_statistics_by_textbook 方法
result = db.session.execute(
    text(f"CALL sp_statistics_by_textbook({textbook_id})")
)
```

**参数**：
| 参数 | 类型 | 说明 |
|------|------|------|
| p_textbook_id | INT | 教材ID |

---

### 1.3 sp_statistics_by_date_range - 按日期范围统计 ✅ 已调用

**功能描述**：按日期范围统计每月的订购、到货和发放数量。

**SQL定义位置**：`sql/04_create_procedures.sql`

**调用位置**：`app/services/statistics_service.py`

**调用方式**：
```python
# statistics_service.py - get_statistics_by_date_range 方法
result = db.session.execute(
    text(f"CALL sp_statistics_by_date_range('{start_date}', '{end_date}')")
)
```

**参数**：
| 参数 | 类型 | 说明 |
|------|------|------|
| p_start_date | DATE | 开始日期 |
| p_end_date | DATE | 结束日期 |

---

### 1.4 sp_statistics_by_publisher - 按出版社统计 ✅ 已调用

**功能描述**：按出版社统计教材的订购、到货、发放数量和当前库存。

**SQL定义位置**：`sql/04_create_procedures.sql`

**调用位置**：`app/services/statistics_service.py`

**调用方式**：
```python
# statistics_service.py - get_statistics_by_publisher 方法
result = db.session.execute(text("CALL sp_statistics_by_publisher()"))
```

---

### 1.5 sp_generate_order_no - 生成订单编号 ✅ 已调用

**功能描述**：自动生成订单编号，格式为 `PO` + `YYYYMMDD` + `4位序号`。

**SQL定义位置**：`sql/04_create_procedures.sql`

**调用位置**：`app/services/purchase_service.py`

**调用方式**：
```python
# purchase_service.py - generate_order_no 方法
result = db.session.execute(
    text("CALL sp_generate_order_no(@order_no)")
)
order_no = db.session.execute(text("SELECT @order_no")).scalar()
```

**生成示例**：`PO202601120001`

---

### 1.6 sp_generate_stock_in_no - 生成入库单号 ✅ 已调用

**功能描述**：自动生成入库单号，格式为 `SI` + `YYYYMMDD` + `4位序号`。

**SQL定义位置**：`sql/04_create_procedures.sql`

**调用位置**：`app/services/stock_in_service.py`

**调用方式**：
```python
# stock_in_service.py - generate_stock_in_no 方法
db.session.execute(text("CALL sp_generate_stock_in_no(@stock_in_no)"))
result = db.session.execute(text("SELECT @stock_in_no"))
stock_in_no = result.scalar()
```

**生成示例**：`SI202601120001`

---

### 1.7 sp_inventory_warning - 库存预警 ⚠️ 已被视图替代

**功能描述**：查询库存异常（不足或过多）的教材信息。

**SQL定义位置**：`sql/04_create_procedures.sql`

**状态**：此存储过程功能已被视图 `v_inventory_warning` 替代，项目中不再调用。

> 💡 保留此存储过程作为备用方案，如需删除请执行：`DROP PROCEDURE IF EXISTS sp_inventory_warning;`

---

## 二、视图 (Views)

### 2.1 v_inventory_warning - 库存预警视图 ✅ 已调用

**功能描述**：展示库存异常（库存不足或库存过多）的教材信息，包含预警级别和缺口数量。

**SQL定义位置**：`sql/07_create_views.sql`

**调用位置**：
1. `app/dao/inventory_dao.py`
2. `app/services/statistics_service.py`

**调用方式**：
```python
# inventory_dao.py - get_warnings 方法
result = db.session.execute(text("""
    SELECT 
        textbook_id,
        isbn,
        textbook_name,
        publisher_name,
        type_name,
        current_quantity,
        min_quantity,
        max_quantity,
        warning_status
    FROM v_inventory_warning
    ORDER BY warning_level ASC, gap_quantity DESC
"""))
```

```python
# statistics_service.py - get_inventory_warnings 方法
result = db.session.execute(text("""
    SELECT 
        textbook_id, isbn, textbook_name,
        publisher_name, type_name,
        current_quantity, min_quantity, max_quantity,
        warning_status
    FROM v_inventory_warning
    ORDER BY warning_level ASC, gap_quantity DESC
"""))
```

**视图字段**：
| 字段 | 说明 |
|------|------|
| textbook_id | 教材ID |
| isbn | ISBN号 |
| textbook_name | 教材名称 |
| publisher_name | 出版社名称 |
| type_name | 教材类型 |
| current_quantity | 当前库存 |
| min_quantity | 最低库存预警值 |
| max_quantity | 最高库存预警值 |
| warning_status | 库存状态（库存不足/库存过多） |
| warning_level | 预警级别（1=库存不足，2=库存过多） |
| gap_quantity | 缺口/超量数量 |

**优势**：相比存储过程 `sp_inventory_warning`，视图支持更灵活的查询条件和排序。

---

### 2.2 v_textbook_detail - 教材详情视图 ⚠️ 扩展功能

**功能描述**：整合教材基本信息、出版社、类型和库存信息的综合视图。

**SQL定义位置**：`sql/07_create_views.sql`

**状态**：此视图为扩展功能，当前项目中未被后端代码调用，可供未来优化使用或直接在MySQL中查询。

**视图字段**：
| 字段 | 说明 |
|------|------|
| textbook_id | 教材ID |
| isbn | ISBN号 |
| textbook_name | 教材名称 |
| author | 作者 |
| publisher_name | 出版社名称 |
| type_name | 教材类型 |
| current_quantity | 当前库存 |
| inventory_value | 库存价值（单价×数量） |
| stock_status | 库存状态 |

**直接查询示例**：
```sql
-- 在MySQL Workbench中查询所有教材详情
SELECT * FROM v_textbook_detail;

-- 查询库存不足的教材
SELECT textbook_name, publisher_name, current_quantity, stock_status
FROM v_textbook_detail
WHERE stock_status = '库存不足';
```

---

## 三、触发器 (Triggers)

> 💡 触发器是自动执行的，不需要显式调用。当相应的数据库操作发生时，触发器会自动触发。

### 3.1 trg_stock_in_after_insert - 入库后更新库存 ✅ 自动触发

**功能描述**：当插入入库记录时，自动更新库存表和订单状态。

**SQL定义位置**：`sql/03_create_triggers.sql`

**触发时机**：`AFTER INSERT ON stock_in`

**触发场景**：`app/services/stock_in_service.py` 中调用 `create_stock_in` 方法创建入库单时

**自动执行的操作**：
1. 更新库存表 `inventory` 的当前库存数量
2. 更新库存表的累计入库数量和最后入库日期
3. 更新订单表 `purchase_order` 的已到货数量
4. 自动判断并更新订单状态（部分到货/已到货）

**代码关联**：
```python
# stock_in_service.py - create_stock_in 方法
# 创建入库单（触发器会自动更新库存）
stock_in = self.stock_in_dao.create(data)
db.session.commit()
```

---

### 3.2 trg_stock_in_before_delete - 删除入库前回退库存 ✅ 自动触发

**功能描述**：当删除入库记录时，自动回退库存和订单的到货数量。

**SQL定义位置**：`sql/03_create_triggers.sql`

**触发时机**：`BEFORE DELETE ON stock_in`

**触发场景**：`app/services/stock_in_service.py` 中调用 `delete_stock_in` 方法删除入库单时

**自动执行的操作**：
1. 检查库存是否充足可回退
2. 回退库存表的当前库存数量
3. 回退订单表的已到货数量
4. 更新订单状态
5. 如果库存不足，抛出错误阻止删除

**代码关联**：
```python
# stock_in_service.py - delete_stock_in 方法
try:
    self.stock_in_dao.delete(stock_in_id, soft=False)
    db.session.commit()
except Exception as e:
    # 如果触发器抛出错误（如库存不足），会在这里捕获
    raise BusinessException(f'删除失败：{str(e)}')
```

---

### 3.3 trg_textbook_after_insert - 教材新增后初始化库存 ✅ 自动触发

**功能描述**：当新增教材时，自动在库存表中创建对应的库存记录。

**SQL定义位置**：`sql/03_create_triggers.sql`

**触发时机**：`AFTER INSERT ON textbook`

**触发场景**：`app/dao/textbook_dao.py` 中通过 `create` 方法新增教材时

**自动执行的操作**：
1. 在库存表 `inventory` 中插入新记录
2. 初始化库存数量为 0

---

### 3.4 trg_purchase_order_before_update - 订单状态保护 ✅ 自动触发

**功能描述**：保护已完成的订单，防止非法修改状态。

**SQL定义位置**：`sql/03_create_triggers.sql`

**触发时机**：`BEFORE UPDATE ON purchase_order`

**触发场景**：`app/services/purchase_service.py` 中更新订单时

**自动执行的操作**：
1. 如果订单状态为"已取消"，阻止修改为其他状态
2. 如果订单状态为"已发放"，阻止修改为其他状态
3. 抛出错误信息给应用层

---

## 四、调用关系图

```
┌─────────────────────────────────────────────────────────────────────┐
│                         后端服务层                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  statistics_service.py                                              │
│    ├── CALL sp_statistics_by_type()                                │
│    ├── CALL sp_statistics_by_textbook(id)                          │
│    ├── CALL sp_statistics_by_date_range(start, end)                │
│    ├── CALL sp_statistics_by_publisher()                           │
│    └── SELECT FROM v_inventory_warning                              │
│                                                                     │
│  purchase_service.py                                                │
│    └── CALL sp_generate_order_no(@order_no)                        │
│                                                                     │
│  stock_in_service.py                                                │
│    ├── CALL sp_generate_stock_in_no(@stock_in_no)                  │
│    ├── INSERT INTO stock_in → 触发 trg_stock_in_after_insert       │
│    └── DELETE FROM stock_in → 触发 trg_stock_in_before_delete      │
│                                                                     │
│  inventory_dao.py                                                   │
│    └── SELECT FROM v_inventory_warning                              │
│                                                                     │
│  textbook_dao.py (通过 BaseDAO)                                     │
│    └── INSERT INTO textbook → 触发 trg_textbook_after_insert       │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 五、总结

| 类型 | 对象名称 | 状态 | 调用位置 |
|------|---------|------|---------|
| 存储过程 | sp_statistics_by_type | ✅ 已调用 | statistics_service.py |
| 存储过程 | sp_statistics_by_textbook | ✅ 已调用 | statistics_service.py |
| 存储过程 | sp_statistics_by_date_range | ✅ 已调用 | statistics_service.py |
| 存储过程 | sp_statistics_by_publisher | ✅ 已调用 | statistics_service.py |
| 存储过程 | sp_generate_order_no | ✅ 已调用 | purchase_service.py |
| 存储过程 | sp_generate_stock_in_no | ✅ 已调用 | stock_in_service.py |
| 存储过程 | sp_inventory_warning | ⚠️ 已被视图替代 | - |
| 视图 | v_inventory_warning | ✅ 已调用 | inventory_dao.py, statistics_service.py |
| 视图 | v_textbook_detail | ⚠️ 扩展功能 | - |
| 触发器 | trg_stock_in_after_insert | ✅ 自动触发 | INSERT INTO stock_in |
| 触发器 | trg_stock_in_before_delete | ✅ 自动触发 | DELETE FROM stock_in |
| 触发器 | trg_textbook_after_insert | ✅ 自动触发 | INSERT INTO textbook |
| 触发器 | trg_purchase_order_before_update | ✅ 自动触发 | UPDATE purchase_order |

---

> 📅 文档生成时间：2026年1月12日
